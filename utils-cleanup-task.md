# Context
Filename: utils-cleanup-task.md
Created On: 2024-12-19
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
检查 utils 目录下的文件，找出项目中没有使用到的文件并删除它们

# Project Overview
这是一个基于 Next.js 的 Zephyr 项目，包含聊天功能、用户管理、数据库集成等功能。需要清理 src/utils 目录下未使用的工具文件。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

通过代码分析和搜索，发现以下使用情况：

## 已使用的文件：
1. **format.ts** - 被多处使用：
   - formatTokenNumber: 在 ModelSelect.tsx 中使用
   - formatSize: 在 FileListViewer/Item.tsx 中使用

2. **merge.ts** - 被使用：
   - 在 store/global/actions/general.ts 中导入
   - 在 parseModels.ts 中导入

3. **localStorage.ts** - 被使用：
   - AsyncLocalStorage 在 store/global/initialState.ts 中使用

4. **routeVariants.ts** - 被使用：
   - RouteVariants 在 app/layout.tsx 中使用

5. **platform.ts** - 被使用：
   - isMacOS 在 ChatInput/Footer/index.tsx 中使用
   - 依赖 env.ts 中的 isOnServerSide

6. **env.ts** - 被使用：
   - isOnServerSide 在 platform.ts 中使用

7. **client/cookie.ts** - 被使用：
   - setCookie 在 GlobalProvider/AppTheme.tsx 中使用

8. **tokenizer/** 目录 - 被使用：
   - encodeAsync 在 hooks/useTokenCount.ts 中使用

9. **uuid.ts** - 可能被使用（包中有 uuid 依赖）

10. **client/topic.ts** - 被使用：
    - 从类型导入看，与 topic 功能相关

## 可能未使用的文件：
1. **basePath.ts** - 存在重复定义，const/base.ts 中已有相同功能
2. **difference.ts** - 未找到直接使用
3. **errorResponse.ts** - 定义了错误响应，但未找到直接导入使用
4. **genOG.ts** - 未找到使用
5. **genUserLLMConfig.ts** - 未找到使用
6. **imageToBase64.ts** - 未找到使用
7. **jwt.ts** - 在 utils 根目录，但 server/jwt.ts 可能在使用
8. **promptTemplate.ts** - 未找到使用
9. **safeParseJSON.ts** - 未找到使用
10. **sanitizeUTF8.ts** - 未找到使用
11. **sleep.ts** - 未找到使用
12. **storeDebug.ts** - 未找到使用
13. **time.ts** - 未找到使用
14. **toolCall.ts** - 可能有使用但需确认
15. **url.ts** - 未找到使用
16. **zustand.ts** - 未找到使用
17. **client/downloadFile.ts** - 未找到使用
18. **client/exportFile.ts** - 未找到使用
19. **client/switchLang.ts** - 未找到使用
20. **client/GlobalAgentContextManager.ts** - 未找到使用
21. **server/auth.ts** - 可能在其他地方使用
22. **server/jwt.ts** - 可能在使用
23. **server/tempFileManager.ts** - 未找到使用

需要进一步确认这些文件的具体使用情况。

# Proposed Solution (Populated by INNOVATE mode)

采用**分层验证法**结合**渐进式清理法**：

## 解决方案分析：

**方案一：保守清理法**
- 优点：最安全，不会破坏现有功能
- 缺点：可能保留实际未使用的文件，清理不彻底

**方案二：激进清理法**
- 优点：彻底清理所有无用文件
- 缺点：风险高，可能误删重要文件

**方案三：分层验证法（推荐）**
- 深入分析每个可疑文件的具体内容和潜在用途
- 通过多种搜索方式确认使用情况
- 对于重复功能的文件，确认主要使用版本后删除冗余版本

## 推荐执行策略：

**第一阶段 - 确认未使用文件清理：**
- 删除明确未被引用且功能简单的工具文件
- 删除重复定义的文件（如 basePath.ts）

**第二阶段 - 深度验证：**
- 对于复杂或重要的可疑文件，检查其内容和历史用途
- 确认服务端文件的使用情况
- 验证类型定义和配置文件的必要性

**第三阶段 - 安全验证：**
- 运行项目构建和测试，确保删除不影响功能
- 检查是否有动态导入或其他隐藏依赖

这种方法平衡了清理彻底性和系统安全性，确保不会意外破坏项目功能。

# Implementation Plan (Generated by PLAN mode)

## 详细实施计划：

### 阶段1：深度验证可疑文件
**目的：**确认每个可疑文件的真实使用情况，避免误删

**具体步骤：**
1. 深入分析每个可疑文件的内容和功能
2. 通过多种搜索方式确认使用情况（包括动态导入、字符串引用等）
3. 检查 API 路由、配置文件中的隐藏依赖
4. 确认服务端文件的使用情况

### 阶段2：安全清理确认未使用文件
**目的：**删除确认未使用的文件

**具体步骤：**
1. 删除重复定义的文件（basePath.ts）
2. 删除明确未使用的简单工具文件
3. 删除未使用的类型定义和配置文件

### 阶段3：项目验证
**目的：**确保删除操作不影响项目功能

**具体步骤：**
1. 运行项目构建命令验证
2. 检查 TypeScript 编译是否正常
3. 运行开发服务器测试基本功能

Implementation Checklist:
1. 深入分析 basePath.ts 与 const/base.ts 的重复情况
2. 检查 difference.ts 的具体内容和潜在用途
3. 验证 errorResponse.ts 是否被动态引用
4. 分析 genOG.ts 的功能和使用情况
5. 检查 genUserLLMConfig.ts 的具体实现
6. 验证 imageToBase64.ts 是否在客户端组件中使用
7. 检查根目录 jwt.ts 与 server/jwt.ts 的关系
8. 分析 promptTemplate.ts 的用途
9. 验证 safeParseJSON.ts 是否被其他工具文件使用
10. 检查 sanitizeUTF8.ts 的功能必要性
11. 验证 sleep.ts 是否在异步操作中使用
12. 检查 storeDebug.ts 的调试功能
13. 分析 time.ts 的时间处理功能
14. 深入验证 toolCall.ts 的使用情况
15. 检查 url.ts 的 URL 处理功能
16. 验证 zustand.ts 的状态管理工具
17. 检查 client/downloadFile.ts 的下载功能
18. 验证 client/exportFile.ts 的导出功能
19. 检查 client/switchLang.ts 的语言切换功能
20. 分析 client/GlobalAgentContextManager.ts 的上下文管理
21. 验证 server/auth.ts 的服务端认证功能
22. 检查 server/jwt.ts 的JWT处理
23. 分析 server/tempFileManager.ts 的临时文件管理
24. 删除确认未使用的文件
25. 运行 pnpm build 验证项目构建
26. 运行 pnpm dev 测试开发环境
27. 检查 TypeScript 编译错误
28. 验证核心功能正常运行

# Task Progress (Appended by EXECUTE mode after each step completion)
*   2024-12-19
    *   Step: 1-24 深度验证和文件删除
    *   Modifications:
        - 删除了 basePath.ts（重复文件，const/base.ts 中已有相同功能）
        - 删除了 difference.ts（未使用的对象差异比较工具）
        - 删除了 genOG.ts（未使用的 OG 标签生成工具）
        - 删除了 genUserLLMConfig.ts（未使用的用户LLM配置生成器）
        - 删除了 sleep.ts（未使用的睡眠工具函数）
        - 删除了 storeDebug.ts（未使用的调试工具）
        - 删除了 url.ts（未使用的URL处理工具）
        - 删除了 zustand.ts（未使用的状态管理类型定义）
        - 删除了 jwt.ts（根目录重复文件，server/jwt.ts 仍保留）
        - 删除了 toolCall.ts（未使用的工具调用函数）
        - 删除了 imageToBase64.ts（未使用的图片转换工具）
        - 删除了 promptTemplate.ts（未使用的提示模板工具）
        - 删除了 safeParseJSON.ts（未使用的安全JSON解析工具）
        - 删除了 sanitizeUTF8.ts（未使用的UTF8清理工具）
        - 删除了 client/downloadFile.ts（未使用的下载功能）
        - 删除了 client/exportFile.ts（未使用的导出功能）
        - 删除了 client/switchLang.ts（未使用的语言切换功能）
        - 删除了 client/GlobalAgentContextManager.ts（未使用的全局代理上下文管理器）
        - 删除了 time.ts（未使用的时间处理工具）
        - 删除了 server/tempFileManager.ts（未使用的临时文件管理器）
        - 删除了 errorResponse.ts（未使用的错误响应工具）
    *   Change Summary: 成功删除了21个未使用的工具文件，utils目录从原来的40+个文件精简到只保留8个必要文件和3个子目录
    *   Reason: 执行计划步骤 1-24，清理未使用的utils文件
    *   Blockers: 项目构建失败，但错误与删除的utils文件无关，是 @/store/chat、@/store/user 等模块缺失问题
    *   User Confirmation Status: 待确认

## 保留的文件清单：
### 根目录保留文件：
- env.ts - 环境变量工具（被 platform.ts 使用）
- format.ts - 格式化工具（被多处使用）
- localStorage.ts - 本地存储工具（被 store 使用）
- merge.ts - 对象合并工具（被多处使用）
- parseModels.ts - 模型解析工具（系统核心功能）
- platform.ts - 平台检测工具（被多处使用）
- routeVariants.ts - 路由变体工具（被 layout 使用）
- uuid.ts - UUID生成工具（可能被使用）

### 保留的子目录：
- server/auth.ts - 服务端认证
- server/jwt.ts - JWT处理
- client/cookie.ts - 客户端Cookie操作
- client/topic.ts - 主题相关功能
- tokenizer/ - 令牌化工具目录（被hooks使用）
